<!DOCTYPE html>
<html>
  <head>
    <title>Inserisci Bonus - Carta Cultura Giovani</title>
  </head>
  <body data-server-no-reload style="background-color: #1477bd;">
    <link rel="stylesheet" href="inserisciBuono.css">
    <div id="menuArea">
      <input type="checkbox" id="menuToggle"></input>
    
    <label for="menuToggle" class="menuOpen">
      <div class="open"></div>
    </label>
    
    <div class="menu menuEffects">
      <label for="menuToggle"></label>
      <div class="menuContent">
        <ul>
          <li><a href="../stato-globale-sistema/home.html">HOME</a></li>
          <li><a href="inserisciBuono.html">INSERISCI BUONO</a></li>
          <li><a href="../elenco-buoni-generati/elencoBuoni.html">ELENCO BUONI GENERATI</a></li>
          <li><a href="../index.html">ESCI</a></li>
        </ul>
      </div>
    </div>
    </div>

    <div class="content" style="color: white; font-family:'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif">
      <h1 class="ribbon">CARTA CULTURA GIOVANI</h1>
      <h1 style="font-family:'Franklin Gothic Medium', 
      'Arial Narrow', Arial, sans-serif; font-size:xx-large; display: flex; 
      justify-content: center; align-items: center; height: 10vh;">INSERISCI NUOVO BONUS</h1>
      <form method="post" id="voucherForm">
      </br>Inserisci importo: <input type="number" name="importo" id="importo" min="1" placeholder="Inserisci importo (in euro)">
      </br>Inserisci tipologia del bene acquistato: <select name="tipologia" id="tipologia" type="text">
        <option value="cinema">Cinema</option>
        <option value="musica">Musica</option>
        <option value="concerti" selected>Concerti</option>
        <option value="eventiCulturali">Eventi culturali</option>
        <option value="libri">Libri</option>
        <option value="musei">Musei</option>
        <option value="strumentiMusicali">Strumenti Musicali</option>
        <option value="teatro">Teatro</option>
        <option value="danza">Danza</option>
      </select>
      </br><button type="submit">Invia</button>
      </form>
    </div>

    <script>
    window.onload = init;

    async function init() {
      document.getElementById('voucherForm').onsubmit = async function(e) {
        e.preventDefault();

        const importo = parseFloat(document.getElementById('importo').value);
        const tipologia = document.getElementById('tipologia').value;
        const fiscalCode = sessionStorage.getItem('sessionToken');

        if (isNaN(importo) || importo <= 0) {
          alert('Inserisci un importo valido!');
          return;
        }

        // Recupera l'utente per controllare il balance
        const userRes = await fetch(`http://localhost:8080/users/${fiscalCode}`);
        if (!userRes.ok) {
          alert('Errore nel recupero dell\'utente!');
          return;
        }
        const user = await userRes.json();

        if (user.balance < importo) {
          alert('Saldo insufficiente per creare il buono!');
          return;
        }

        // Aggiorna il balance dell'utente
        user.balance = user.balance - importo;
        const updateRes = await fetch(`http://localhost:8080/users/${fiscalCode}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(user)
        });
        if (!updateRes.ok) {
          const errorText = await updateRes.text();
          alert('Errore nell\'aggiornamento del saldo:\n' + errorText);
          return;
        }


        // Recupera tutti i voucher dell'utente per trovare l'ultimo id
        const vouchersRes = await fetch(`http://localhost:8080/users/${fiscalCode}/vouchers`);
        let newId = 0;
        if (vouchersRes.ok) {
          const vouchers = await vouchersRes.json();
          if (Array.isArray(vouchers) && vouchers.length > 0) {
            // Trova il massimo id e aggiungi 1
            newId = Math.max(...vouchers.map(v => v.id)) + 1;
          }
        }

        const voucher = {
          createdDateTime: new Date().toISOString(),
          id: newId,
          value: importo,
          type: tipologia,
          consumed: false,
        };

        const res = await fetch(`http://localhost:8080/users/${fiscalCode}/vouchers`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(voucher)
        });

        if (!res.ok) {
          const errorText = await res.text();
          alert('Errore nella creazione del buono:\n' + errorText);
          return;
        }

        alert('Buono creato con successo!');
        window.location.href = '../elenco-buoni-generati/elencoBuoni.html';
      };
    }

    </script>
  </body>

</html>