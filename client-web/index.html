<!DOCTYPE html>
<html>
  <head>
    <title>Carta Cultura Giovani</title>
  </head>
  <body data-server-no-reload>
    <link rel="stylesheet" href="autentica-registra-utente/autenticaUtente.css">
    <section class="forms-section">
      <h1 class="section-title" style="font-family:'Franklin Gothic Medium', 
      'Arial Narrow', Arial, sans-serif; font-size:xx-large;">Carta Cultura Giovani</h1>
      <div class="forms">
        <div class="form-wrapper is-active">
          <button type="button" class="switcher switcher-login">
            Autenticazione 
            <span class="underline"></span>
          </button>
          <form class="form form-login" id="formAutenticazione">
            <fieldset>
              <legend>Per favore, inserisci un codice fiscale valido per autenticarti.</legend>
              <div class="input-block">
                <label for="autenticazione-cf">Codice fiscale</label>
                <input id="autenticazione-cf" type="cf" required>
              </div>
            </fieldset>
            <button type="submit" class="btn-login">Autenticati</button>
          </form>
        </div>
        <div class="form-wrapper">
          <button type="button" class="switcher switcher-signup">
            Registrati
            <span class="underline"></span>
          </button>
          <form class="form form-signup" id="formRegistrazione">
            <fieldset>
              <legend>Per favore, inserisci nome, cognome, email codice fiscale validi per registrarti.</legend>
              <div class="input-block">
                <label for="signup-nome">Nome</label>
                <input id="signup-nome" type="nome" required>
              </div>
              <div class="input-block">
                <label for="signup-cognome">Cognome</label>
                <input id="signup-cognome" type="cognome" required>
              </div>
              <div class="input-block">
                <label for="signup-email">E-mail</label>
                <input id="signup-email" type="email" required>
              </div>
              <div class="input-block">
                <label for="signup-cf">Codice fiscale</label>
                <input id="signup-cf" type="cf" required>
              </div>
            </fieldset>
            <button type="submit" class="btn-signup">Continua</button>
          </form>
        </div>
      </div>
    </section>
    <script>
      const API_URI = "http://localhost:8080";
      
      // Gestisco le animazioni della pagina
      
      const switchers = [...document.querySelectorAll('.switcher')]

      switchers.forEach(item => {
	      item.addEventListener('click', function() {
		      switchers.forEach(item => item.parentElement.classList.remove('is-active'));
		      this.parentElement.classList.add('is-active');
	      });
      });

      
      // GESTIONE DELLA AUTENTICAZIONE
      async function createCollectionOnPageLoad(fiscalCode) {
        try {
          // Prepara il corpo della richiesta in formato JSON con la chiave "collectionCF"
          const requestBody = JSON.stringify({ fiscalCode });

          const response = await fetch('http://localhost:8080/users', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: requestBody // Usa il corpo della richiesta preparato
          });

          if (!response.ok) {
            // Se il server risponde con un errore, registra i dettagli dell'errore
            const errorDetails = await response.json();
            console.error('Si è verificato un errore durante la creazione della collezione. Il server dice:', errorDetails);
          } else {
            // Registra il messaggio di successo
            const successMessage = await response.json();
            console.log(successMessage);
          }
        } catch (error) {
          console.error('Errore:', error);
        }
      }

      // Chiama la funzione createCollection non appena la pagina viene caricata
      window.onload = function() {
        createCollectionOnPageLoad("Location");
      };

      function resetLoginForm() {
        // Resetta il form di autenticazione
        document.getElementById('formAutenticazione').reset();
      }

      document.getElementById('formAutenticazione').addEventListener('submit', async function (event) {
        event.preventDefault(); // Previene che il form venga inviato in modo tradizionale

        // Serializzo i dati contenuti nel form di autenticazione in JSON
        const formData = new FormData(this);
        const jsonData = {};

        // Inizializzo il codice fiscale a una stringa vuota
        jsonData.fiscalCode = "";

        formData.forEach((value, key) => {
          jsonData[key] = value;
        });

        // Tento l'autenticazione mandando una richiesta di tipo POST
        try {
          const response = await fetch('http://localhost:8080/users', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify(jsonData)
          });

          if (!response.ok) {
            // Se la risposta non è OK, gestisco l'errore
            const errorDetails = await response.text();
            throw new Error('È stato riscontrato un errore durante la fase di autenticazione. Ulteriori dettagli: ' + errorDetails);
          }

          // On successful login, store the session token and redirect to the homepage
          sessionStorage.setItem('sessionToken', jsonData.fiscalCode); // Salvo il codice fiscale nella sessione
          window.location.replace('/stato-globale-sistema/home.html'); // Reindirizzo alla home page
          resetLoginForm(); // Reset the form fields
        } catch (error) {
          console.error('Errore:', error.message);
          // Preparo i dati per il debug
          const requestBodyDebugInfo = JSON.stringify(jsonData, null, 2); // Pretty print JSON
          // Mostro un alert con le informazioni di debug
          alert('Errore durante la fase di autenticazione. Si prega di tentare di nuovo. Ulteriori dettagli: ' + error.message + '\nRequest Body: ' + requestBodyDebugInfo);
        }
      });
      

      // GESTIONE DELLA REGISTRAZIONE
      // Reset della registrazione
      function resetRegistrationForm() {
        document.getElementById('formRegistrazione').reset();
      }

      // Aggiungo EventListener per il form di registrazione
      document.getElementById('formRegistrazione').addEventListener('submit', async function(event) {
        event.preventDefault(); // Previene che il form venga inviato in modo tradizionale

        // Serializzo i dati contenuti nel form di registrazione in JSON
        const formData = new FormData(this);
        const jsonData = {};

        formData.forEach((value, key) => {
          jsonData[key] = value;
        });
        // Controllo se l'e-mail è già in uso
        try {
          const controlloEmail = await fetch('http://localhost:8080/users', {
            method: 'GET',
            headers: {
              'Accept': 'application/json'
            }
          });

          if (!controlloEmail.ok) {
            const dettagliErrore = await checkResponse.text();
            throw new Error('È stato riscontrato un errore con la mail. Il server ha risposto nella seguente maniera: ' + dettagliErrore);
          }

          const emails = await checkResponse.json(); // Il server dovrebbe ritornare un array di email
          const email = formData.get('email');

          if (emails.includes(email)) {
            alert('Questa mail risulta essere già in uso. Si prega di usarne una nuova.');
            window.location.reload(); // Aggiorna la pagina
            return;
          }
        } catch (error) {
          console.error('Errore:', error.message);
          alert('È stato riscontrato un errore con la mail. Si prega di tentare di nuovo.');
          return;
        }
        
        // Se la email non è ancora in uso proseguo con la registrazione
        try {
          const response = await fetch('http://localhost:8080/users', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Accept': 'application/json'
            },
            body: JSON.stringify(jsonData)
          });
          jsonData.balance = 500; // Setto il balance a 500

          if (!response.ok) {
            const errorDetails = await response.text();
            throw new Error('È stato risconstrato un errore con la registrazione. Il server ha risposto nella seguente maniera: ' + errorDetails);
          }

          // Gestione di una registrazione avvenuta con successo
          const fiscalCode = await response.json(); // Estraggo codice fiscale
          console.log('Codice Fiscale:', fiscalCode);
          sessionStorage.setItem('sessionToken', fiscalCode); // Carico all'interno della sessione

          // Aspetta 0.5 secondi prima di reindirizzare
          setTimeout(() => {
            window.location.replace('/stato-globale-sistema/home.html');
          }, 500);
          resetRegistrationForm(); // Resetta credenziali della registrazione a seguito del cambio di pagina

        } catch (error) {
          console.error('Errore:', error.message);
          const requestBodyDebugInfo = JSON.stringify(jsonData, null, 2); 
          alert('Errore nella registrazione utente. Si prega di tentare di nuovo. Debug info: ' + error.message + '\nRequest Body: ' + requestBodyDebugInfo);
        }
      });

    </script>
  </body>

</html>